'use strict';function $(a){return document.getElementById(a)}const week="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),messes={},table={},slots=[];let favorites=[],date=new Date,weekdayoffset=1,day="",timemsg="",ongoing="",upcoming="",timeslot=[],selectedmess="All";
fetch("data.json").then(a=>a.json()).then(a=>{Object.assign(messes,a.messes);weekdayoffset=a.weekdayoffset;a='<input class="column button-outline" type="button" value="All" onclick="updateDOM(\'All\')">';for(let b in messes)a+=`<input class="column button-outline" type="button" value="${b}" onclick="updateDOM('${b}')">`;$("messes").innerHTML=a;updateTimeleft();dateadd(0);a="";for(let b of week)a+=`<input class="column button-outline ${b==day?"button-clear":""}" type="button" value="${b.slice(0,3)}" data-day="${b}" onclick="dateset('${b}')">`;
$("days").innerHTML=a});localStorage.favorites&&(favorites=localStorage.favorites.split("\n"),generateexport());$("showblankcategories").checked=+localStorage.showblankcategories?1:0;$("showcategories").checked=+localStorage.showcategories?1:0;$("showonlyfavorites").checked=+localStorage.showonlyfavorites?1:0;setInterval(updateTimeleft,6E4);function clean(a){return a.replace(/__\d+/,"")}function dateadd(a){a?date.setDate(date.getDate()+a):date=new Date;loadtable(date);updateDOM()}
function dateset(a){for(date=new Date;date.toLocaleDateString("en-us",{weekday:"long"})!=a;)date.setDate(date.getDate()+1);loadtable(date);updateDOM()}function setCheck(a){localStorage[a.id]=a.checked?1:0;updateDOM()}function importfav(a){console.log(a.files);const b=new FileReader;b.onload=()=>{const c=b.result.match(/([^>]+ > [^>]+ > [^>]+\n)*([^>]+ > [^>]+ > [^>]+\n?)/)[0];c&&console.log(b.result==c)};a.files.length&&b.readAsText(a.files[0])}
function loadtable(a){var b=new Date(a);a=b.getDay();day=b.toLocaleDateString("en-us",{weekday:"long"});for(let c in messes){table[c]={};b=Object.entries(messes[c].menu[(a-weekdayoffset+7)%7]).slice(1);let e=0;for(let d in messes[c].sections)slots.includes(d)||slots.push(d),table[c][d]=b.slice(e,e+=messes[c].sections[d][0])}}function hmin(a){a=(a%24+24)%24;const b=Math.floor(a);a=Math.round(60*(a-b));return`${b?`${b} h`:""} ${a?`${a} min`:""}`}
function updateTimeleft(){"All"==selectedmess&&(selectedmess=Object.keys(messes)[0]);timeslot=[];const a=date.getHours()+date.getMinutes()/60,b=messes[selectedmess].sections;let c;upcoming=ongoing="";for(let d in b){var e=b[d][1];c=b[d][2];if(a<e){timemsg=`${d} in ${hmin(e-a)}`;upcoming=d;break}else if(a<=c){timemsg=`Mess open for ${d}, closing in ${hmin(c-a)}`;ongoing=upcoming=d;timeslot=[e,c,a];break}}""==upcoming&&(e=Object.keys(b)[0],timemsg=`${e} in ${hmin(b[e][1]-a)}`,upcoming=e);updateDOM()}
function generateexport(){$("export").href=`data:text/plain;charset=utf-8,${encodeURIComponent(localStorage.favorites)}`}function goto(a){const [b,c,e]=a.innerText.split(" > ");dateset(c);updateDOM(b,e)}
function search(a){if(3>a.length)updateDOM();else{let b=[];const c=a.trim().split(" ");for(let d in messes)for(let h in messes[d].menu)for(let g in messes[d].menu[h])c.every(f=>messes[d].menu[h][g].match(new RegExp(f,"i")))&&b.push([d,week[(+h+weekdayoffset+7)%7],messes[d].menu[h][g]].join(" > "));let e=`<h2>${b.length} results found for '${a}'</h2>`;for(let d of b)e+=`<li><a href="#" onclick="goto(this)">${d.replace(new RegExp(c.join("|"),"ig"),"<mark>$&</mark>")}</a></li>`;$("table").innerHTML=
b.length?`<ul>${e}</ul>`:`<h2>'${a}' not found in menu :(</h2>`}}function heart(a,b,c=!0){c?(favorites.includes(b)||favorites.push(b),a.className="fa-solid fa-heart",a.outerHTML=`<i class="fa-solid fa-heart" onclick="heart(this,'${b}',0)"></i>`):(favorites=favorites.filter(e=>e!=b),a.className="fa-regular fa-heart",a.outerHTML=`<i class="fa-regular fa-heart" onclick="heart(this,'${b}')"></i>`);localStorage.favorites=favorites.join("\n");generateexport()}
function updateDOM(a=null,b=null){selectedmess=a||localStorage.selected||"All";localStorage.selected=selectedmess;$("msg").innerHTML=timemsg;timeslot.length?($("progress").classList.remove("hide"),$("progress").value=(timeslot[2]-timeslot[0])/(timeslot[1]-timeslot[0])):$("progress").classList.add("hide");for(var c of $("days").children)c.getAttribute("data-day")==day?c.classList.remove("button-outline"):c.classList.add("button-outline");for(var e of $("messes").children)e.value==selectedmess?e.classList.remove("button-outline"):
e.classList.add("button-outline");a="";c=!0;for(let h in table)if("All"==selectedmess||h==selectedmess){a+="<tr>";"All"==selectedmess&&(a+=`<th><h3>${h}</h3></th>`);for(let g of slots){e=0;let f='<table class="box">';g==upcoming?(c=!1,f+=`<th class="upcoming">${g} `,f+=g==ongoing?'<i class="fa-solid fa-lock-open"></i>':'<i class="fa-solid fa-lock"></i>'):(f+=`<th>${g}`,c&&(f+=' <i class="fa-solid fa-check-double"></i>'));f+="</th>";if(!+localStorage.showonlyfavorites||favorites.includes(`${h} > ${g}`)){var d=
`${day} > ${h} > ${g}`;f=favorites.includes(d)?f+`<i class="fa-solid fa-heart" onclick="heart(this,'${d}',0)"></i>`:f+`<i class="fa-regular fa-heart" onclick="heart(this,'${d}')"></i>`;for(let k of table[h][g])f+="<tr>",k[1]?(+localStorage.showcategories&&(f+=`<th>${clean(k[0])}</th>`),d=k[1],b&&(d=d.replace(new RegExp(b,"ig"),"<mark>$&</mark>")),f+=`<td>${d}</td>`,e++):+localStorage.showblankcategories&&(f+=`<td><strike>${clean(k[0])}</strike></td>`,e++),f+="</tr>";f+="</table>"}e?(a+=g==upcoming?
'<td class="upcoming">':"<td>",a+=f+"</td>"):a+="<td></td>"}a+="</tr>"}"<tr><td></td><td></td><td></td><td></td></tr>"==a&&(a+=`<h2>No favorites in '${selectedmess}' :(</h2>`);$("table").innerHTML=`<tbody class="slots">${a}</tbody>`};